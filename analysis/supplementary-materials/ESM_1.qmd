---
title: "Online Resources 1: Supplementary results and tables"
subtitle: "From Stone to Tool: How Raw Materials Influenced Upper Paleolithic Technology in Southwestern Iberia (Vale Boi). Archaeological and Anthropological Sciences"
author:
  - Joana Belmiro:
      correspondence: "yes"
      email: jfbelmiro@ualg.pt
      orcid: 0000-0003-4951-2907
      institute:
        - ICArEHB
  - Nuno Bicho:
      institute: ICArEHB
      orcid: 0000-0001-9655-0549
  - Xavier Terradas:
      institute: CSIC
      orcid: 0000-0002-8000-5607
  - João Cascalheira:
      orcid: 0000-0003-0321-8892
      institute: ICArEHB
institute:
  - ICArEHB:
      name: Interdisciplinary Center for Archaeology and the Evolution of Human Behaviour, University of Algarve, Faro, Portugal
  - CSIC:
      name: Spanish National Research Council - Institute Milá y Fontanals of research on Humanities, Barcelona, Spain
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: false
  warning: false
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: ../paper/references.bib
csl: "../templates/archaeological-and-anthropological-sciences.csl" # Insert path for the bib-style
---

```{r}
#| label: library

library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(knitr)
library(janitor)

```

```{r}
#| label: get-data

# Reading the datasets
## Technological data
gravettian_tech <- read_csv(here::here('analysis/data/raw_data/VBT_6_7_JB.csv'))
proto_tech <- read_csv(here::here('analysis/data/raw_data/VBT_4E_5_JB.csv'))
solutrean_JC <- read_csv(here::here('analysis/data/raw_data/VBR_ABC_JC.csv'))
solutrean_points <- read_csv(here::here('analysis/data/raw_data/shelter_points_JC.csv'))

## RM data
shelter_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_SHELTER.csv')) # Shelter RM analysis
terrace_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_TERRACE.csv')) # Terrace RM analysis

## Context data
context <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_context.csv')) # Terrace Field DB - lithic artefact info
xyz <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_xyz.csv')) # Terrace Field DB - just coordinates

```

```{r}
#| label: databases-setup

# Setting up the Terrace dataset
cols_to_concat_terrace <- c("UNIT", "ID") # Vector to join UNIT and ID into a single variable
context$ID <- str_squish(context$ID) # Remove empty spaces from ID field
xyz$ID <- str_squish(xyz$ID) # Remove empty spaces from UNIT field

# Cleaning up DS and uniformising variable names
proto_tech_WIP <- proto_tech |>
  tidyr::unite(col='ID', all_of(cols_to_concat_terrace), sep="-", remove=TRUE) |> 
  rename(CLASS = Class, COREPREPPROD = CorePreparProd, PIECECOMPLETENESS = PieceCompleteness, CORTEX = Cortex, CORTEXLOCATION = CortexLocation, PLATFORMTYPE = PlatformType, PLATFORMCORTEX = PlatformCortex, SCARCOUNT = ScarCount, THICKNESS = Thickness,
        MAXWIDTH = MaxWidth, LENGTH = Length, COREPLATFORM = CorePlatform, MAINFACECORTEX = MainFaceCortex, 
        MAINFACESCARCOUNT = MainFaceScarCount, COREABANDON = CoreAbandon, RETOUCHEDPIECETYPOLOGY = RetouchedPieceTypology) |> 
  dplyr::select(ID, CLASS, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE, PLATFORMCORTEX,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, MAINFACECORTEX, MAINFACESCARCOUNT, COREABANDON, RETOUCHEDPIECETYPOLOGY)

gravettian_tech <- gravettian_tech |> 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS)) |> 
  dplyr::mutate(RETOUCHEDPIECETYPOLOGY = case_when( # Solving typing issue
    RETOUCHEDPIECETYPOLOGY == "Carenated endscrapper" ~ "Carenated endscraper",
    RETOUCHEDPIECETYPOLOGY == "Endscrapper" ~ "Endscraper",
    RETOUCHEDPIECETYPOLOGY == "Endscrapper-burin" ~ "Burin",
    TRUE ~ RETOUCHEDPIECETYPOLOGY))

terrace_tech <- bind_rows(proto_tech_WIP, gravettian_tech) # Creating single DS with Proto and Gravettian

terrace_RM_WIP <- terrace_RM |> 
  mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 2" | RMTYPE == "Type 2" ~ "T2",
    RMTYPE == "Chalcedony" ~ "T1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "T3",
    RMTYPE == "TYPE 7" ~ "T4",
    RMTYPE == "TYPE 12" ~ "T5",
    RMTYPE == "TYPE 11" ~ "T6",
    RMTYPE == "TYPE 13" ~ "T7",
    RMTYPE == "TYPE 11F" ~ "T8",
    RMTYPE == "TYPE 13B" ~ "T9",
    RMTYPE == "Oolitic" ~ "T10",
    RMTYPE == "TYPE GB" ~ "T11",
    .default = RMTYPE)) |> 
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) %>%
  distinct(ID, .keep_all = TRUE)

context <- context |>
  dplyr::rename("UNIT" = "Unit") |> # Renaming first column from Unit to UNIT to use cols_to_concat
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) |> # Unite UNIT with ID using cols_to_concat
  select(ID, Level, Spit, Code) |> # Selecting important variables: ID refers to artifact ID; Level refers to archaeologycal layer; Spit refers to artificial levels within an archaeological layer; Code refers to type of artifact (e.g., LITHIC or BONE)
  distinct(ID, .keep_all = TRUE)

xyz <- xyz |>
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) |> # Unite UNIT with ID using cols_to_concat
  filter(Suffix == 0) |> # To avoid several entries related to several points of the same artefact
  select(ID, X, Y, Z) |> # Selecting important variables
  distinct(ID, .keep_all = TRUE)

field_data <- full_join(xyz, context, by = "ID") # Join field tables

terrace_tech_WIP <- left_join(terrace_tech, field_data, by = "ID") # Join field and RM type tables
terrace_dataset <- full_join(terrace_tech_WIP, terrace_RM_WIP, by = "ID") # Base 12690
terrace_dataset <- terrace_dataset |>
  filter(!Level %in% c("3", "4", "4C", "4D")) |>  # Dropping NAs on the technological class drops dataset to 1651
  drop_na(RMTYPE) |>  # Dropping NAs on the RM database drops dataset to 3635
  drop_na(CLASS) # Dropping NAs on the technological class drops dataset to 1647
  
# Mutate level 5 to add phases: top of 5 (4E/5) and bottom of 5 (5), following Belmiro et al. (2020).
phase_dataset <- terrace_dataset |> 
  mutate(Level = case_when(
    Level == 5 & Z > 24.1 ~ "4E/5",
    Level == 5 & Z < 24.1 ~ "5",
    Level == "7C" | Level == 8 ~ "7", # Collapsing samples from Level 7C and Level 8 into 7 to homogenise dataset
    TRUE ~ Level)) |> # Adding technocomplex name based on the levels
  mutate(Technocomplex = case_when(
    Level == "4E" | Level == "4E/5" | Level == 5 ~ "Proto-Solutrean",
    Level == 6 | Level == 7 ~ "Gravettian")) |> 
  mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Splintered piece with notch" | RETOUCHEDPIECETYPOLOGY == "Splintered piece with lateral retouch" | RETOUCHEDPIECETYPOLOGY == "Splintered piece fragment" ~ "Splintered piece",
    RETOUCHEDPIECETYPOLOGY == "Retouched blade" | RETOUCHEDPIECETYPOLOGY == "Retouched bladelet" | RETOUCHEDPIECETYPOLOGY == "Retouched flake" | RETOUCHEDPIECETYPOLOGY == "Retouched burin spall" ~ "Retouched blank",
    RETOUCHEDPIECETYPOLOGY == "Retouched bladelet frag" | RETOUCHEDPIECETYPOLOGY == "Retouched flake frag" | RETOUCHEDPIECETYPOLOGY == "Retouched flake siret fragment"  ~ "Retouched blank fragment",
    RETOUCHEDPIECETYPOLOGY == "Multiple burin" | RETOUCHEDPIECETYPOLOGY == "Burin splintered piece" | RETOUCHEDPIECETYPOLOGY == "Burin on truncation" | RETOUCHEDPIECETYPOLOGY == "Retouched burin" ~ "Burin",
    RETOUCHEDPIECETYPOLOGY == "Dentilhado" ~ "Denticulate",
    RETOUCHEDPIECETYPOLOGY == "Right truncation on retouched piece" ~ "Truncation",
    RETOUCHEDPIECETYPOLOGY == "Backed bladelet" | RETOUCHEDPIECETYPOLOGY == "Backed flake" | RETOUCHEDPIECETYPOLOGY == "Double backed bladelet" | RETOUCHEDPIECETYPOLOGY == "Backed bladelet parcial" ~ "Backed tool",
    RETOUCHEDPIECETYPOLOGY == "Carenated endscraper" ~ "Endscraper",
    TRUE ~ RETOUCHEDPIECETYPOLOGY)) |> 
  # --Article review--
  mutate(elong = MAXWIDTH*2-LENGTH) %>%
  mutate(CLASS_ELONG = case_when( 
    CLASS == "Blank" & elong > 0 ~ "Flake",
    CLASS == "Blank" & elong <= 0 ~ "ElongatedProd",
    TRUE ~ CLASS))
  
# Setting up the Shelter dataset
cols_to_concat_shelter <- c("YEAR", "ID") # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

solutrean_WIP <- solutrean_JC |> 
  filter(Layer %in% c("A", "B", "C")) |> # Filtering Solutrean layers
  filter(`Raw material` %in% c("Chert", "Chalcedony")) |>  # Filtering raw materials
  filter(!Screen %in% c("Crivo", "crivo")) |>  # Filtering out all bucket lithics since they were not included in the RM analysis
  mutate_at("Date", str_replace, "20", "") |> # Removing initial part of the year to match IDs
  dplyr::rename("YEAR" = "Date") |> 
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=FALSE) # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

# Dataset filtering for chert/chalcedony and levels (A-C), 3298 + 61 solutrean points, n=3359
solutrean_original_chert <- solutrean_JC |> 
  filter(Layer %in% c("A", "B", "C")) |> # Filtering Solutrean layers
  filter(`Raw material` %in% c("Chert", "Chalcedony")) |> 
  filter(Class != "Chip")

# In Cascalheira 2010 Retouched piece was not a category but a variable. To match the other DBs, this category was added
solutrean_WIP <- solutrean_WIP |> 
  mutate(Class = case_when( # This alteration is being done on the original class column
    Retouched == "Yes" ~ "RetouchedPiece", # Whenever retouch is present, class is now Retouched piece
    TRUE ~ Class)) |> 
  mutate(CLASS = case_when( # Creating a column for clustered classes, to match the other DBs
    Class == "Blade" | Class == "Bladelet" ~ "ElongBlank", # Cluster blades with bladelets. The distinction can come later through a mutate and the measurements
    Class == "Core front" | Class == "Core tablet" | Class == "Core trimming elem." | Class == "Crested piece" ~ "CorePrepProd", # Cluster all preparation products
    Class == "Fragment" ~ "Shatter",
    Class == "Flake distal frag." | Class == "Flake mesial frag." | Class == "Flake prox. frag." ~ "FlakeFrag", # Cluster flake frags into a single category
    Class == "Blade distal frag." | Class == "Blade mesial frag." | Class == "Blade prox. frag." 
    | Class == "Bladelet distal frag." | Class == "Bladelet mesial frag." | Class == "Bladelet prox. frag." ~ "ElongBlankFrag", # Cluster elong frags into a single category
    TRUE ~ Class)) |> 
  mutate(COREPREPPROD = case_when( # Creating a column for the types of core preparation and maintenance products (COREPREPPROD)
    Class == "Core front" ~ "Core front",
    Class == "Core tablet" ~ "Core tablet",
    Class == "Core trimming elem." ~ "Core trim",
    Class == "Crested piece" ~ "Crested piece")) |> 
  mutate(PIECECOMPLETENESS = case_when( # Creating a column for the portions present in flake or elongblank fragments to match other DBs
    Class == "Flake distal frag." | Class == "Blade distal frag." | Class == "Bladelet distal frag." ~ "Distal",
    Class == "Flake mesial frag." | Class == "Blade mesial frag." | Class == "Bladelet mesial frag." ~ "Mesial",
    Class == "Flake prox. frag." | Class == "Blade prox. frag." | Class == "Bladelet prox. frag." ~ "Proximal")) |> 
  rename(PLATFORMTYPE = Platform_type) |> # Renaming column
  mutate(PLATFORMTYPE = case_when( # Renaming variables to match correspondent variables in the other DBs
    PLATFORMTYPE == "Multifacetted" ~ "Faceted",
    PLATFORMTYPE == "Unfacetted" ~ "Plain",
    TRUE ~ PLATFORMTYPE)) |>
  mutate(Type = case_when( # Translating retouched types from Zilhão 1997 to simplified typologies
    Type == "92b" ~ "Retouched piece fragment",
    Type == "92a" ~ "Retouched blank",
    Type == "76" ~ "Splintered piece",
    Type == "75" ~ "Denticulate",
    Type == "74" ~ "Notch",
    Type == "66" ~ "Retouched blade",
    Type == "61" ~ "Truncation",
    Type == "28" ~ "Burin",
    Type == "7" | Type == "5b" | Type == "4"  ~ "Endscraper",
    TRUE ~ Type)) |>
  rename(LEVEL = Layer, UNIT = Unit, CORTEX = Percent_of_cortex, CORTEXLOCATION = Loc_of_cortex, THICKNESS = Thickness,
         MAXWIDTH = Width, LENGTH = Length, COREPLATFORM = Core_platfform, SCARCOUNT = N_of_Scars, COREABANDON = Core_abandon,
         RETOUCHEDPIECETYPOLOGY = Type)  # Renaming column
  
solutrean_tech <- solutrean_WIP |>
  dplyr::select(ID, CLASS, LEVEL, UNIT, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, COREABANDON, RETOUCHEDPIECETYPOLOGY)

solutrean_points <- solutrean_points |> 
  mutate_at("YEAR", str_replace, "20", "") |> # Removing initial part of the year to match IDs
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=TRUE)
  
solutrean_tech <- bind_rows(solutrean_tech, solutrean_points) # Uniting technology dataset with points (2167 to 2228)

solutrean_tech <- solutrean_tech |> # Originally 2228
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets (down to 1993)

shelter_RM_WIP <- shelter_RM |>
  mutate_at("ID", str_replace, "VB", "") |> # Remove "VB" from ID
  mutate(RMTYPE = case_when(
    RMTYPE == "Type 2" | RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "Chalcedony" ~ "T1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "T3",
    RMTYPE == "TYPE 7" ~ "T4",
    RMTYPE == "TYPE 12" ~ "T5",
    RMTYPE == "TYPE 11" ~ "T6",
    RMTYPE == "TYPE 13" ~ "T7",
    RMTYPE == "TYPE 11F" ~ "T8",
    RMTYPE == "TYPE 13B" ~ "T9",
    RMTYPE == "Oolitic" ~ "T10",
    RMTYPE == "TYPE GB" ~ "T11",
    RMTYPE == "ND_A" ~ "INDET",
    .default = RMTYPE)) |>
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) |>  # Select variables
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets

solutrean_dataset <- full_join(solutrean_tech, shelter_RM_WIP, by = "ID") # The complete dataset has 2818 (44 points) entries
solutrean_dataset <- solutrean_dataset |>
  drop_na(RMTYPE) |>   # Dropping NAs on the RM database drops dataset to 1514
  drop_na(CLASS) |>  # Dropping NAs on the technological class drops dataset to 914
  dplyr::mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Bifacial fragment" ~ "Bifacial blank",
    RETOUCHEDPIECETYPOLOGY == "Shouldered point fragment" ~ "Shouldered point",
    RETOUCHEDPIECETYPOLOGY == "Retouched blade" ~ "Retouched blank",
    TRUE ~ RETOUCHEDPIECETYPOLOGY))
  
```

# Assemblage description

```{r}
#| label: general-tables

# Tables with class by raw material type (n and %)
general_table_som <- phase_dataset |> 
  dplyr::mutate(CLASS_ELONG = case_when(
    CLASS_ELONG == "BlankFrag" ~ "Blank fragment",
    CLASS_ELONG == "ElongatedProd" ~ "Elongated blank",
    CLASS_ELONG == "BurinSpall" ~ "Burin spall",
    CLASS_ELONG == "CoreFrag" ~ "Core fragment",
    CLASS_ELONG == "CorePreparProd" ~ "Core prep product",
    CLASS_ELONG == "RetouchedPiece" ~ "Retouched",
    CLASS_ELONG == "RetouchedPieceFrag" ~ "Retouched fragment",
    TRUE ~ CLASS_ELONG)) |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE)) |> 
  filter(CLASS != "Chip")

## For Gravettian
gravettian_general_som <- general_table_som |>
  filter(Level %in% c(6, 7)) |>
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1","T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL", "INDET"))) |>
  mutate(CLASS_ELONG = factor(CLASS_ELONG, levels = c("Flake", "Elongated blank", "Blank fragment", "Burin spall", "Core", "Core fragment", "Core prep product", "Retouched", "Retouched fragment", "Shatter"))) |> 
  tabyl(CLASS_ELONG, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

## For Proto-Solutrean (4E and top of 5)
proto_general_som <- general_table_som |> 
  filter(Level %in% c("4E", "4E/5")) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1","T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL", "INDET"))) |>
  mutate(CLASS_ELONG = factor(CLASS_ELONG, levels = c("Flake", "Elongated blank", "Blank fragment", "Burin spall", "Core", "Core fragment", "Core prep product", "Retouched", "Retouched fragment", "Shatter"))) |> 
  tabyl(CLASS_ELONG, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

## For Solutrean
solutrean_general_som <- solutrean_dataset |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE)) |>
  dplyr::mutate(CLASS = case_when(
    CLASS == "ElongBlank" ~ "Elongated blank",
    CLASS == "ElongBlankFrag" | CLASS == "FlakeFrag" ~ "Blank fragment",
    CLASS == "CorePrepProd" ~ "Core prep product",
    CLASS == "RetouchedPiece" | CLASS == "Retouched piece" ~ "Retouched",
    CLASS == "Retouched piece fragment" ~ "Retouched fragment",
    TRUE ~ CLASS)) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1","T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL", "INDET"))) |>
    mutate(CLASS = factor(CLASS, levels = c("Flake", "Elongated blank", "Thinning flake", "Blank fragment", "Burin spall", "Core", "Core fragment", "Core prep product", "Retouched", "Retouched fragment", "Shatter"))) |> 
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

```

```{r}
#| label: tool-diversity

# Solutrean table
## Table preparation
solutrean_retouch <- solutrean_dataset |>
    mutate(CLASS = case_when(
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE)) |> 
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |>
  filter(RETOUCHEDPIECETYPOLOGY != "")

## Janitor tabyl for final table with n and %
solutrean_retouch_tab <- solutrean_retouch |>
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |>
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, "T2-5", T6, T7, T8, T11, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

# Proto-solutrean table
## Table preparation
proto_retouch <- phase_dataset |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  filter(Level %in% c("4E", "4E/5")) |>
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE)) |> 
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY)

## Janitor tabyl for final table with n and %
proto_retouch_tab <- proto_retouch |>
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |> 
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, "T2-5", T6, T7, T8, T9, TL, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

# Gravettian table
## Table preparation
gravettian_retouch <- phase_dataset |> 
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  filter(Level %in% c(6, 7)) |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE)) |> 
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |> 
  dplyr::group_by(RMTYPE)
## Janitor tabyl for final table with n and %
gravettian_retouched_tab <- gravettian_retouch |> 
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |>
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, "T2-5", T6, T7, T8, T9, T10, TL, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

```

```{r}
#| label: TL-cherts

TL_classes_terrace <- phase_dataset |> 
  filter(RMTYPE == "TL") |> 
  filter(Level != "5") |>
  select(Technocomplex, SUBTYPE, ID, CLASS, RETOUCHEDPIECETYPOLOGY)

TL_classes_shelter <- solutrean_dataset |> 
  mutate(Technocomplex = case_when(
    LEVEL == "A" | LEVEL == "B" | LEVEL == "C" ~ "Solutrean")) |> 
  filter(RMTYPE == "TL") |> 
  select(Technocomplex, SUBTYPE, ID, CLASS, RETOUCHEDPIECETYPOLOGY)

TL_classes <- rbind(TL_classes_terrace, TL_classes_shelter)
TL_classes <- TL_classes |> 
  rename(TL = SUBTYPE) |> 
  arrange(TL)

```

## Gravettian (levels 6-7)

The sample studied for the Gravettian occupation (\>2012 excavations) of the Terrace area included 766 artifacts. Of these, 209 (`r round(209*100/766, 2)`%) have an indeterminate chert type (@tbl-general-gravettian). Chalcedony (T1) and local cherts (T2-5) show a total of `r 35+212` artefacts (`r round((35+212)*100/766, 2)`%). Non-local cherts show different numbers of artefacts depending on the type, with T6 and T7 showing the highest values (169 or `r round(169*100/766, 2)`% of the total assemblage, and 86 or `r round(86*100/766, 2)`%, respectively); the other non-local cherts have artefact counts lower than 20 per type. The TL cherts also show smaller numbers, with 12 artefacts, corresponding to 7 different types of TL cherts [@tbl-TL-classes].

```{r}
#| label: tbl-general-gravettian
#| tbl-cap: Number and percentage of techno-typological classes by cherts type from the Gravettian assemblage (levels 6 and 7) of the Terrace area of Vale Boi.

kable(gravettian_general_som)

```

```{r}
#| label: tbl-TL-classes
#| tbl-cap: Trace lithologies cherts (TL) from the Gravettian and Proto-Solutrean assemblages of the Terrace and Solutrean assemblage from the Shelter and corresponding technological class.

kable(TL_classes)

```

@tbl-general-gravettian shows the number and percentages of technological classes per chert type. For local cherts, blanks (including blank fragments) represent more than 50% of the artefacts. Cores and core maintenance products are only present in small frequencies: \<10% and \<2%, respectively. Retouched tools seem to be especially relevant in local T2-5 cherts (\~16%), making them the most frequent class after blanks and blank fragments, followed by shatter (\~10%). T1 (chalcedony) shows similar patterns to other local cherts, although with higher percentages of shatter (34.3%).

When compared to local cherts, non-local chert types (especially T6 and T7) show similar percentages of blanks (n=`r 44+24` or 40% and `r 21+21`\`or \~50%, respectively) but higher percentages of retouched tools (\~30%). Cores, core fragments and core preparation and maintenance products are also present in all non-local cherts (excluding TL) even if in percentages below 4% (n\<4), as well as shatter (\~12%). The exception is T6 that shows the highest numbers of cores and core fragments (n=8), although with low frequencies (4.6%). The TL cherts show mostly blanks and blank fragments (n=3 and n=2, respectively), and retouched tools (n=4).

As seen in @tbl-retouch-gravettian, 170 retouched tools were identified, with 39 (`r round(39*100/170, 2)`%) having an unidentified chert type. From the identified chert types, `r 3+35` (`r round((3+35)*100/170, 2)`%) of retouched tools are from local types, `r 58+24+3+1+3` (`r round((58+24+3+1+3)*100/170, 2)`%) from non-local cherts and 4 are from the TL group. From all chert types, T6 shows the highest numbers of retouched pieces (n=58, `r round(58*100/170, 2)`%). Regarding typologies, 8 types of retouched tools were identified (excluding retouched tool fragments). All these typologies were found in the non-local chert group, while only 5 retouched tool typologies were identified in local cherts/chalcedony. The most common typologies identified in the assemblage (and for all chert types) were burins (n=54), endscrapers (n=18), retouched blanks (n=38) and splintered pieces (n=26). From all these, the majority were produced in non-local chert, mainly T6 and in lesser numbers T7. Although in lesser numbers as well, backed tools were also identified (n=7), but only present in non-local chert types (T6 and T7). The presence of burin spalls in local chert, especially T2 (n=11) and non-local cherts (T6 with n=12 and T7 with n=4) is expected due to the prevalence of burins (@tbl-general-gravettian).

```{r}
#| label: tbl-retouch-gravettian
#| tbl-cap: Retouched tools (n) by chert type of the Gravettian assemblage (levels 6 and 7) of the Terrace area.

kable(gravettian_retouched_tab)
  
```

## Proto-Solutrean (levels 4E and top of level 5)

The final lithic sample from the Proto-Solutrean assemblage (levels 4E and top of level 5), consists of 635 artifacts. Of these, 167 (`r round(167*100/635, 2)`%) have an indeterminate chert type. Local cherts correspond to `r 32+303` artefacts (`r round((32+303)*100/635, 2)`%), with T4 being the most present local chert. Non-local types are present in smaller numbers (n=`r 60+47+13+9+1` or `r round((60+47+13+9+1)*100/635, 2)`%), with T6 and T7 being the most relevant (n=60 and n=47, respectively), and the TL group includes 3 artefacts, corresponding to 2 types of TL cherts [@tbl-TL-classes].

When crossing the lithic class with chert type (@tbl-general-proto), we see that the local types show high frequency of blanks (\>50%, including blank fragments), followed by shatter (\~20-30%). Cores are present in small numbers (n=`r 4+5+13+6`), corresponding to \~10% of the classes in local types, with the exception of T1 (chalcedony), with no cores. Core preparation and maintenance products are absent in all local cherts. For non-local types, especially those with higher number of artefacts (T6-T8), blanks and blank fragments are the most frequent class (48.3%, 53.1% and 69.2%, respectively). Retouched tools are present in smaller frequencies for the previous mentioned chert types (\~17-23%). For T6 the absence of cores but the presence of shatter and a single core preparation and maintenance product suggests knapping on site; all other non-local types show at least 1 core and frequently the presence of shatter. As expected, the TL artifacts include a blank and a retouched. However, a shatter was also identified [@tbl-TL-classes].

```{r}
#| label: tbl-general-proto
#| tbl-cap: Number and percentage of techno-typological classes by chert type from the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area of Vale Boi.

kable(proto_general_som)

```

In total, 65 chert retouched tools were identified, with 23.1% (n=15) having an unidentified chert type (@tbl-retouch-proto). A total of `r 1+25` (`r round((1+25)*100/65, 2)`%) retouched tools correspond to local cherts, while `r 10+9+3+1+1` (`r round((10+9+3+1+1)*100/65, 2)`%) correspond to non-local and TL cherts. As seen in @tbl-retouch-proto, 11 different types of retouched tools were identified. Endscrapers (n=18), retouched blanks (n=14), splintered pieces (n=11) and burins (n=8) were the most prevalent. Local raw materials show 8 different typologies, with Vale Comprido points, Solutrean retouch and notches being present only in the local types, even if in small numbers. Non-local cherts show 8 different typologies of retouched tools. Perforator-endscraper, truncation and backed bladelet typologies can only be found in non-local varieties, albeit also in small numbers.

```{r}
#| label: tbl-retouch-proto
#| tbl-cap: Retouched tools (n) by chert type of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area.

kable(proto_retouch_tab)

```

## Solutrean (levels A to C)

The Solutrean assemblages show similar patterns to those observed in previous assemblages. The final sample from levels A, B and C from the Solutrean occupations of the Shelter area consists of 910 artifacts. Of these, 201 (`r round(201*100/914, 2)`%) correspond to the indeterminate chert group. Local cherts correspond to `r 16+548` (`r round((16+548)*100/914, 2)`%) artefacts, mostly from T2. Non-local cherts (including the TL group) correspond to `r 85+9+30+3+1+16+1` (`r round((85+9+30+3+1+16+1)*100/914, 2)`%) artefacts, mostly from T6 (n=85).

When crossing the class data with type of raw material (@tbl-general-solutrean), we see that for local chert, the majority of the debitage is composed of blanks (~80%). Cores are also present (~10%), alongside a small percentage of core preparation and maintenance products (1.3%). In comparison to debitage products, retouched tools are scarce in the sample (\~3%). Non-local cherts, especially T6 and T8, show similar patterns to the local cherts, with high percentages of blanks (\>50%). Cores and core preparation and maintenance are also present in small percentages (\~6-3% and 3.5% only for T6, respectively), as well as retouched tools (\<10%). However, these specific results are truncated by the lack of shatter, which were not present in the sample used for the study (see Materials and Methods section).

```{r}
#| label: tbl-general-solutrean
#| tbl-cap: Number and percentage of techno-typological classes by chert type from the Solutrean assemblage (levels A to C) of the Shelter area of Vale Boi.

kable(solutrean_general_som)

```

The analysed Solutrean sample has a total of 43 retouched tools (complete and fragments), with `r 3+14` corresponding to local cherts and `r 7+1+2+3` to non-local cherts, with the remaining being cherts of unidentified type. These results are significantly reduced from the original dataset, possibly due to no bucket coordinates being used. From the 43 retouched tools, 10 different typologies were identified (without accounting for fragments). The typologies which are most frequently present in the studied sample are bifacial blanks (n=10). Two types of points were identified: shouldered points (n=3, including fragments) and tanged and winged points (n=4). Other frequent retouched typologies are retouched blanks (n=7), notches (n=5), splintered pieces (n=5) and endscrapers (n=4). Local types show a higher variability retouched typologies (9 types), although this may be related to the higher number of tools. In comparison, Type 6 shows only 5 different typologies.

```{r}
#| label: tbl-retouch-solutrean
#| tbl-cap: Retouched tools (n) by chert type of the Solutrean assemblage (level A to C) of the Shelter area.

kable(solutrean_retouch_tab)

```

# Tool-to-debitage ratios

```{r}
#| label: ratios-retouchdebitage

# Solutrean
solutrean_ratiotd <- solutrean_dataset %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

# Proto-Solutrean
proto_ratiotd <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

# Gravettian
gravettian_ratiotd <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

```

```{r}
#| label: tbl-tdratio-solutrean
#| tbl-cap: Tools-to-debitage ratio by chert type of the Gravettian (a), Proto-Solutrean (b) and Solutrean (c) assemblages.
#| tbl-subcap: 
#|  - "Tools-to-debitage ratio by chert type of the Gravettian assemblage (levels 6 and 7) of the Terrace area."
#|  - "Tools-to-debitage ratio by chert type of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area."
#|  - "Tools-to-debitage ratio by chert type of the Solutrean assemblage (levels A to C) of the Shelter area."
#| layout-nrow: 3

kable(gravettian_ratiotd)
kable(proto_ratiotd)
kable(solutrean_ratiotd)

```

# Blank-to-core ratios

```{r}
#| label: ratio-blankcore

# Solutrean ratio
solutrean_ratiobc <- solutrean_dataset %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(RMTYPE != "INDET") %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)

# Proto-Solutrean ratio
proto_ratiobc <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>%
  mutate("Blank/Core" = Blank / Core)

# Gravettian ratio
gravettian_ratiobc <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)


```

```{r}
#| label: tbl-bcratio
#| tbl-cap: Blank-to-core ratio by chert type of the Gravettian (a), Proto-Solutrean (b) and Solutrean (c) assemblages.
#| tbl-subcap: 
#|  - "Blank-to-core ratio by chert type of the Gravettian assemblage (levels 6 and 7) of the Terrace area."
#|  - "Blank-to-core ratio by chert type of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area."
#|  - "Blank-to-core ratio by chert type of the Solutrean assemblage (levels A to C) of the Shelter area."
#| layout-nrow: 3

kable(gravettian_ratiobc)
kable(proto_ratiobc)
kable(solutrean_ratiobc)

```

# Measurements descriptive statistics

```{r}
#| label: stats-setup

# Solutrean statistics
# DS preparation
solutrean_stats <- solutrean_dataset |> 
  filter(RMTYPE != "INDET") |> 
  mutate(CLASS = case_when(
    CLASS == "ElongBlank" ~ "Elongated blank",
    TRUE ~ CLASS)) |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
solutrean_stats_blank <- solutrean_stats |>  
  filter(CLASS == "Flake") |> 
  select(RMTYPE, CLASS, MAXWIDTH, LENGTH, WEIGHT) |> 
  drop_na() |> 
  group_by(RMTYPE, CLASS) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For elongated blanks (complete) --Article review--
solutrean_stats_elong <- solutrean_stats |>  
  filter(CLASS == "Elongated blank") |> 
  select(RMTYPE, CLASS, MAXWIDTH, LENGTH, WEIGHT) |> 
  drop_na() |> 
  group_by(RMTYPE, CLASS) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For cores
solutrean_stats_cores <- solutrean_stats |> 
  filter(CLASS == "Core") |>
  select(RMTYPE, CLASS, MAXWIDTH, LENGTH, WEIGHT) |> 
  drop_na() |> 
  group_by(RMTYPE, CLASS) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))

# Proto-Solutrean statistics
# DS prep
proto_stats <- phase_dataset |> 
  filter(Level %in% c("4E", "4E/5")) |> 
  filter(RMTYPE != "INDET") |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
proto_stats_blank <- proto_stats |> 
  filter(CLASS_ELONG == "Flake") |> 
  select(RMTYPE, CLASS_ELONG, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS_ELONG) |> 
  rename(CLASS = CLASS_ELONG) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For elongated blanks (complete) --Article review--
proto_stats_elong <- proto_stats |> 
  dplyr::mutate(CLASS_ELONG = case_when(
    CLASS_ELONG == "ElongatedProd" ~ "Elongated blank",
    TRUE ~ CLASS_ELONG)) |> 
  filter(CLASS_ELONG == "Elongated blank") |> 
  select(RMTYPE, CLASS_ELONG, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS_ELONG) |> 
  rename(CLASS = CLASS_ELONG) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For cores
proto_stats_cores <- proto_stats |> 
  filter(CLASS == "Core") |> 
  select(RMTYPE, CLASS, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS) |>
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))

# Gravettian statistics
# DS prep
gravettian_stats <- phase_dataset |> 
  filter(Level %in% c(6, 7)) |> 
  filter(RMTYPE != "INDET") |> 
  dplyr::mutate(RMTYPE = case_when(
      RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "T2-5",
      TRUE ~ RMTYPE))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
gravettian_stats_blank <- gravettian_stats |> 
  filter(CLASS_ELONG == "Flake") |> 
  select(RMTYPE, CLASS_ELONG, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS_ELONG) |> 
  rename(CLASS = CLASS_ELONG) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For elongated blanks (complete) --Article review--
gravettian_stats_elong <- gravettian_stats |> 
  dplyr::mutate(CLASS_ELONG = case_when(
    CLASS_ELONG == "ElongatedProd" ~ "Elongated blank",
    TRUE ~ CLASS_ELONG)) |> 
  filter(CLASS_ELONG == "Elongated blank") |> 
  select(RMTYPE, CLASS_ELONG, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS_ELONG) |> 
  rename(CLASS = CLASS_ELONG) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))
# For cores
gravettian_stats_cores <- gravettian_stats |> 
  filter(CLASS == "Core") |> 
  select(RMTYPE, CLASS, MAXWIDTH, LENGTH, WEIGHT) |> 
  group_by(RMTYPE, CLASS) |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2-5", "T6","T7", 
                                        "T8", "T9", "T10", "TL"))) |>
  summarise(across(c(MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd)))

```

```{r}
#| label: tbl-gravettian
#| tbl-cap: "Mean and standard deviation (SD) for Max width, Length and Weight measurements of flakes (a), elongated blanks (b) and cores (c) by chert type of the Gravettian assemblage (levels 6-7) of the Terrace area."
#| tbl-subcap: 
#|  - "Mean and SD for Max width, Length and Weight measurements of flakes."
#|  - "Mean and SD for Max width, Length and Weight measurements of elongated blanks."
#|  - "Mean and SD for Max width, Length and Weight measurements of cores."
#| layout-nrow: 3

kable(gravettian_stats_blank)
kable(gravettian_stats_elong)
kable(gravettian_stats_cores)

```

```{r}
#| label: tbl-proto
#| tbl-cap: "Mean and standard deviation (SD) for Max width, Length and Weight measurements of flakes (a), elongated blanks (b) and cores (c) by chert type of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area."
#| tbl-subcap: 
#|  - "Mean and SD for Max width, Length and Weight measurements of flakes."
#|  - "Mean and SD for Max width, Length and Weight measurements of elongated blanks."
#|  - "Mean and SD for Max width, Length and Weight measurements of cores."
#| layout-nrow: 3

kable(proto_stats_blank)
kable(proto_stats_elong)
kable(proto_stats_cores)

```

```{r}
#| label: tbl-solutrean
#| tbl-cap: "Mean and standard deviation (SD) for Max width, Length and Weight measurements of flakes (a), elongated blanks (b) and cores (c) by chert type of the Solutrean assemblage (levels A to C) of the Shelter area."
#| tbl-subcap: 
#|  - "Mean and SD for Max width, Length and Weight measurements of flakes."
#|  - "Mean and SD for Max width, Length and Weight measurements of elongated blanks."
#|  - "Mean and SD for Max width, Length and Weight measurements of cores."
#| layout-nrow: 3

kable(solutrean_stats_blank)
kable(solutrean_stats_elong)
kable(solutrean_stats_cores)

```

# Measurements non-parametric statistical analysis

```{r}
#| label: stats-wilcox
#| include: false

# Terrace wilcox statistics
## DB prep
wilcox_t <- phase_dataset |> 
  dplyr::mutate(Prov = case_when(
    RMTYPE == "T1" | RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "Local",
    RMTYPE == "T6" | RMTYPE == "T7" | RMTYPE == "T8" | RMTYPE == "T9" ~ "Non-local",
    TRUE ~ RMTYPE)) |> 
  filter(Prov %in% c("Local", "Non-local")) |> 
  select(ID, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT, Prov, Level)

# Proto-Solutrean blanks statistical test
## NL cores were not represented enough (n) for statistics
wt_blank_proto <- wilcox_t |> 
  filter(Level %in% c("4E", "4E/5")) |> 
  filter(CLASS == "Blank")

## Blanks weight (bw)
dplyr::group_by(wt_blank_proto, Prov) |> 
  summarise(count = n(), median = median(WEIGHT, na.rm = TRUE))
res_bw_proto <- wilcox.test(WEIGHT ~ Prov, data = wt_blank_proto, exact = FALSE)
## Blanks length (bl)
dplyr::group_by(wt_blank_proto, Prov) |> 
  summarise(count = n(), median = median(LENGTH, na.rm = TRUE))
res_bl_proto <- wilcox.test(LENGTH ~ Prov, data = wt_blank_proto, exact = FALSE)
## Blanks width (bw)
dplyr::group_by(wt_blank_proto, Prov) |> 
  summarise(count = n(), median = median(MAXWIDTH, na.rm = TRUE))
res_bwi_proto <- wilcox.test(MAXWIDTH ~ Prov, data = wt_blank_proto, exact = FALSE)

# Gravettian blanks statistical test
wt_blank_grav <- wilcox_t |> 
  filter(Level %in% c("6", "7")) |> 
  filter(CLASS == "Blank")

## Blanks weight
dplyr::group_by(wt_blank_grav, Prov) |> 
  summarise(count = n(), median = median(WEIGHT, na.rm = TRUE))
res_bw_grav <- wilcox.test(WEIGHT ~ Prov, data = wt_blank_grav, exact = FALSE)
## Blanks length
dplyr::group_by(wt_blank_grav, Prov) |> 
  summarise(count = n(), median = median(LENGTH, na.rm = TRUE))
res_bl_grav <- wilcox.test(LENGTH ~ Prov, data = wt_blank_grav, exact = FALSE)
## Blanks width
dplyr::group_by(wt_blank_grav, Prov) |> 
  summarise(count = n(), median = median(MAXWIDTH, na.rm = TRUE))
res_bwi_grav <- wilcox.test(MAXWIDTH ~ Prov, data = wt_blank_grav, exact = FALSE)

## Gravettian cores statistical test
wt_core_grav <- wilcox_t |> 
  filter(Level %in% c("6", "7")) |> 
  filter(CLASS == "Core")

## Cores weight
dplyr::group_by(wt_core_grav, Prov) |> 
  summarise(count = n(), median = median(WEIGHT, na.rm = TRUE))
res_cw_grav <- wilcox.test(WEIGHT ~ Prov, data = wt_core_grav, exact = FALSE)
## Cores length
dplyr::group_by(wt_core_grav, Prov) |> 
  summarise(count = n(), median = median(LENGTH, na.rm = TRUE))
res_cl_grav <- wilcox.test(LENGTH ~ Prov, data = wt_core_grav, exact = FALSE)
## Cores width
dplyr::group_by(wt_core_grav, Prov) |> 
  summarise(count = n(), median = median(MAXWIDTH, na.rm = TRUE))
res_cwi_grav <- wilcox.test(MAXWIDTH ~ Prov, data = wt_core_grav, exact = FALSE)

# Shelter wilcox statistics
## DB prep
wilcox_t_shelter <- solutrean_dataset |> 
  dplyr::mutate(Prov = case_when(
    RMTYPE == "T1" | RMTYPE == "T2" | RMTYPE == "T3" | RMTYPE == "T4" | RMTYPE == "T5" ~ "Local",
    RMTYPE == "T6" | RMTYPE == "T7" | RMTYPE == "T8" | RMTYPE == "T9" | RMTYPE == "T11" ~ "Non-local",
    TRUE ~ RMTYPE)) |> 
   mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    TRUE ~ CLASS)) |>
  filter(Prov %in% c("Local", "Non-local")) |> 
  select(ID, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT, Prov, LEVEL)

# Solutrean blanks statistical test
wt_blank_s <- wilcox_t_shelter |>
  filter(CLASS == "Blank")

## Blanks weight
dplyr::group_by(wt_blank_s, Prov) |> 
  summarise(count = n(), median = median(WEIGHT, na.rm = TRUE))
res_bw_s <- wilcox.test(WEIGHT ~ Prov, data = wt_blank_s, exact = FALSE)
## Blanks length
dplyr::group_by(wt_blank_s, Prov) |> 
  summarise(count = n(), median = median(LENGTH, na.rm = TRUE))
res_bl_s <- wilcox.test(LENGTH ~ Prov, data = wt_blank_s, exact = FALSE)
## Blanks width
dplyr::group_by(wt_blank_s, Prov) |> 
  summarise(count = n(), median = median(MAXWIDTH, na.rm = TRUE))
res_bwi_s <- wilcox.test(MAXWIDTH ~ Prov, data = wt_blank_s, exact = FALSE)

wt_core_s <- wilcox_t_shelter |>
  filter(CLASS == "Core")

## Cores weight
dplyr::group_by(wt_core_s, Prov) |> 
  summarise(count = n(), median = median(WEIGHT, na.rm = TRUE))
res_cw_s <- wilcox.test(WEIGHT ~ Prov, data = wt_core_s, exact = FALSE)
## Cores length
dplyr::group_by(wt_core_s, Prov) |> 
  summarise(count = n(), median = median(LENGTH, na.rm = TRUE))
res_cl_s <- wilcox.test(LENGTH ~ Prov, data = wt_core_s, exact = FALSE)
## Cores width
dplyr::group_by(wt_core_s, Prov) |> 
  summarise(count = n(), median = median(MAXWIDTH, na.rm = TRUE))
res_cwi_s <- wilcox.test(MAXWIDTH ~ Prov, data = wt_core_s, exact = FALSE)

p.value_blanks <- tibble(
  Technocomplex = c("Gravettian", " "," ", " ", "Proto-Solutrean", " ", " ", " ", "Solutrean", " ", " ", " "),
  Variable = c("Weight", "Length", "Width", "(n)","Weight", "Length", "Width","(n)", "Weight", "Length", "Width", "(n)"),
  L_median = c("2.8", "25.8", "19.1", "82", "2.2", "23.4", "16.8", "154", "1.7", "25.1", "16.6", "342"),
  NL_median = c("1.9", "21.2", "17.8", "69", "1.7", "19.4", "16.6", "49", "1.5", "21.9", "18.8", "86"),
  P_Value = round(c(res_bw_grav$p.value, res_bl_grav$p.value, res_bwi_grav$p.value, 0, res_bw_proto$p.value, res_bl_proto$p.value, res_bwi_proto$p.value, 0, res_bw_s$p.value, res_bl_s$p.value, res_bwi_s$p.value, 0), 5)) |>   mutate(Significance = case_when(
      P_Value <= 0.001 ~ "***",
      P_Value <= 0.01  ~ "**",
      P_Value <= 0.05  ~ "*",
      TRUE             ~ ""),
    P_value = paste0(format(P_Value, nsmall = 4), Significance)  # Keep decimal places
  ) |> 
  select(-P_Value, -Significance) |> 
  dplyr::mutate(P_value = case_when(
    P_value == "0.00000***" ~ "-",
    TRUE ~ P_value))


p.value_cores <- tibble(
  Technocomplex = c("Gravettian", "", "", "", "Solutrean", "", "", ""),
  Variable = c("Weight", "Length", "Width", "(n)", "Weight", "Length", "Width", "(n)"),
  L_median = c("20", "29.6", "27.6", "14", "16.5", "28.3", "30.7", "59"),
  NL_median = c("11.8", "21.9", "29.7", "10", "11.7", "25.6", "26.0", "7"),
  P_Value = round(c(res_cw_grav$p.value, res_cl_grav$p.value, res_cwi_grav$p.value, 0, res_cw_s$p.value, res_cl_s$p.value, res_cwi_s$p.value, 0), 3)) |> 
  mutate(Significance = case_when(
      P_Value <= 0.001 ~ "***",
      P_Value <= 0.01  ~ "**",
      P_Value <= 0.05  ~ "*",
      TRUE             ~ ""),
    P_value = paste0(format(P_Value, nsmall = 3), Significance)  # Keep decimal places
  ) |> 
  select(-P_Value, -Significance) |> 
  dplyr::mutate(P_value = case_when(
    P_value == "0.000***" ~ "-",
    TRUE ~ P_value))

```

A Mann-Whitney U statistical test was conducted to determine whether there are differences in the measurements (weight, length and width) of blanks and cores between local and non-local cherts. To do this, all local cherts (including chalcedony) were grouped in a Local category (L) while all non-local cherts were grouped in a non-local category (NL). Type 10 and TL cherts were excluded from the NL grouping to avoid adding cherts which are the result of probable different procurement strategies and clearly deviate from the other cherts in terms regarding the measurements. The Solutrean assemblage is not represented in the core statistics due to the small sample size of both local and non-local categories.

The results indicate generally significant differences in blank measurements between local and non-local cherts in all technocomplexes; in almost all measurements and groups, local cherts show higher medians [@tbl-pvalue-1]. Length seems to be consistently significant (p \< 0.01 and \< 0.001) between the two groups in all assemblages, with local cherts showing higher median lengths than non-local cherts. In the Gravettian and Proto-Solutrean assemblages, weight is also significantly different between local and non-local blanks (p \< 0.05), with local cherts presenting higher medians. In comparison, width differences show no statistical significance, with exception of the Solutrean assemblage. In the Solutrean, blank width is significant (p \< 0.05) with the non-local category showing higher medians compared local cherts.

Regarding the cores, in almost all measurements and groups local cherts show higher means than non-local cherts [@tbl-pvalue-2]. Despite these differences, the results are not significant (p \> 0.05). It is important to note, however, that the sample size for cores in the Gravettian assemblage and non-local cherts in the Solutrean assemblage are smaller (n \< 15) than the blank sample size.

```{r}
#| label: tbl-pvalue
#| tbl-cap: "Median values and p value results for the Mann-Whitney U statistical test applied to blank (a) and core (b) measurements (Weight, Length and Max width). All local chert types were grouped in the L category and non-local groups in the NL category. (n) corresponds to the total number of samples used for the statistical tests. * corresponds to significant p values (<0.05), ** to very significant p values (< 0.01) and *** to highly significant p values (0.001)."
#| tbl-subcap: 
#|  - "Median values and p value results for the Mann-Whitney U statistical test applied to blank measurements."
#|  - "Median values and p value results for the Mann-Whitney U statistical test applied to core measurements."
#| layout-nrow: 2

kable(p.value_blanks)
kable(p.value_cores)

```
